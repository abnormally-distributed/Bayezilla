---
title: "R Notebook"
output: html_notebook
---


```{r include=FALSE}
data = read_csv("diabetes.csv")
data = scale(data)
data$sex <- NULL 
```

The first step is to find a suitable reference model. The reference model includes *all* the predictors. Hence, to use this approach one must be able to fit a model including all variables.

```{r message=FALSE, warning=FALSE}
out = glmBayes(prog ~ ., data, family = "laplace")
```

Now, set up the reference model for the **projpred** package. The **projpred** package is part of the Stan family of packages, but this one is designed to be used with any Bayesian model for which one has MCMC samples. The price of this flexibility is just a few lines of code to set up everything.

```{r}
library(projpred)
draws <- as.matrix(as.mcmc(out))
sigma <- draws[,'sigma'] # noise std
beta <- draws[,2:10] # regression coefficients
Intercept <-draws[,'Intercept'] # intercept
rm(draws)
predfun <- function(xt) t(beta %*% t(xt) + Intercept)

ref <- init_refmodel(z = model.matrix(prog ~ . , data)[,-1], 
                     y = data$prog, 
                     predfun = predfun, 
                     dis = sigma, 
                     family = gaussian())
```


```{r}
vs <- varsel(ref)
varsel_plot(vs, stats = "mse") + ggthemes::theme_tufte(ticks = FALSE)
```

In this model 6 predictors gives almost identical performance to the full set of 10 predictors. Which variables are contributing nothing? 

The varsel_stats function in **projpred** can show the rankings of each model (vind) and the cumulative model size (size), along with the mean squared error and expected long predictive density (along with standard errors).

```{r}
varsel_stats(vs, stats = c("mse", "elpd"))
```


```{r}
post_summary(out)
```

Examining the coefficients, it seems that an effect estimated in the reference model to be almost exactly zero shows a negative effect in the sub-model. HDL is often called "good cholesterol", so it makes sense this would have a negative relationship to the progression of diabetes.

```{r}
proj = project(ref, vind = vs$vind[1:4], ns = 20000) 
proj.out = cbind(Intercept = proj$alpha, t(proj$beta))
post_summary(as.mcmc(proj.out))
```


